set_thermostat:
  sequence:
    - condition: state
      entity_id: input_boolean.heating
      state: "on"
    - service: climate.set_preset_mode
      data:
        entity_id: "{{ entity_id }}"
        preset_mode: home
    - service: climate.set_temperature
      data_template:
        entity_id: "{{ entity_id }}"
        temperature: "{{ temperature }}"

increase_temperature:
  sequence:
    - condition: template
      value_template: >
        {% set set_temperature = state_attr(entity_id, "temperature")%}
        {{ is_state(entity_id, "off") or temperature > set_temperature }}
    - service: script.set_thermostat
      data:
        entity_id: "{{ entity_id }}"
        temperature: "{{ temperature }}"

heating_early_morning:
  sequence:
    - service: script.increase_temperature
      data:
        entity_id: climate.living_room
        temperature: 20
    - service: script.increase_temperature
      data:
        entity_id: climate.bedroom
        temperature: 19.5
    - service: input_boolean.turn_off
      entity_id: input_boolean.preheating

heating_morning:
  sequence:
    - service: script.refresh_morning_timer
    - service: script.increase_temperature
      data:
        entity_id: climate.living_room
        temperature: 20
    - service: script.increase_temperature
      data:
        entity_id: climate.kitchen
        temperature: 19
    # - service: script.increase_temperature
    #   data:
    #     entity_id: climate.kid_s_room
    #     temperature: "{{ states('input_number.default_kids_room_temperature') | float }}"
    - service: climate.turn_off
      entity_id:
          - climate.bedroom
          - climate.loft
    - service: input_boolean.turn_off
      entity_id: input_boolean.preheating

heating_work:
  sequence:
    - service: script.set_thermostat
      data:
        entity_id: climate.office
        temperature: 19.5
    - service: climate.turn_off
      entity_id:
          - climate.bedroom
          - climate.loft

heating_away:
  sequence:
    - service: climate.turn_off
      entity_id:
          - climate.kitchen
          - climate.bedroom
          - climate.office
          - climate.loft
          - climate.kid_s_room
    - condition: state
      entity_id: input_boolean.heating
      state: "on"
    - service: climate.set_preset_mode
      data:
        entity_id: climate.living_room
        preset_mode: away
    - service: climate.set_temperature
      data_template:
        entity_id: climate.living_room
        temperature: 16

heating_close:
  sequence:
    - service: script.increase_temperature
      data:
        entity_id: climate.living_room
        temperature: 20

heating_back:
  sequence:
    - service: script.increase_temperature
      data:
        entity_id: climate.living_room
        temperature: 20
    - service: script.increase_temperature
      data:
        entity_id: climate.kitchen
        temperature: 19
    # - service: script.increase_temperature
    #   data:
    #     entity_id: climate.kid_s_room
    #     temperature: "{{ states('input_number.default_kids_room_temperature') | float }}"

heating_bedrooms:
  sequence:
    - service: script.increase_temperature
      data:
        entity_id: climate.bedroom
        temperature: 20
    - condition: state
      entity_id: input_boolean.guest_mode
      state: "on"
    - service: script.increase_temperature
      data:
        entity_id: climate.loft
        temperature: "{{ states('input_number.default_loft_temperature') | float }}"

heating_night:
  sequence:
    - service: script.refresh_heating_off_timer
    - service: script.set_thermostat
      data:
        entity_id: climate.living_room
        temperature: 16
    - service: script.set_thermostat
      data:
        entity_id: climate.bedroom
        temperature: 18.5
    - service: climate.turn_off
      entity_id:
          - climate.kitchen
          - climate.office
          - climate.kid_s_room
    - condition: state
      entity_id: input_boolean.heating
      state: "off"
    - service: climate.turn_off
      entity_id:
          - climate.living_room
          - climate.bedroom

boost_heating:
  sequence:
    - condition: template
      value_template: "{{ state_attr(zone, 'temperature') <= 21 }}"
    - service: script.increase_temperature
      data:
        entity_id: "{{ zone }}"
        temperature: "{{ state_attr(zone, 'temperature') + 1 }}"
    - delay: '00:30:00'
    - service: script.set_thermostat
      data:
        entity_id: "{{ zone }}"
        temperature: "{{ state_attr(zone, 'temperature') - 1 }}"

refresh_early_morning_timer:
  sequence:
    - service: input_datetime.set_datetime
      target:
        entity_id: input_datetime.heating_on
      data:
        time: >
          {% set temp = states('sensor.living_room_temperature') %}  
          {% set target = 20 %}
          {% set speed = 30 %}
          {{ (((state_attr('input_datetime.morning' , 'timestamp')) - ((target - float(temp)) * speed * 60))|timestamp_custom('%H:%M', false)) }}

refresh_morning_timer:
  sequence:
    - service: input_datetime.set_datetime
      target:
        entity_id: input_datetime.morning
      data:
        time: "{{ '08:30' if is_state('binary_sensor.workday_tomorrow', 'on') else '08:30' }}"

refresh_heating_off_timer:
  sequence:
    - service: input_datetime.set_datetime
      target:
        entity_id: input_datetime.heating_off
      data:
        time: "22:00"
